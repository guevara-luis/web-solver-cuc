<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Num√©rica ‚Äì Newton-Raphson</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <h2 class="mb-4 text-center">Calculadora Num√©rica ‚Äì Newton-Raphson</h2>
  <form id="solveForm">
    <div class="mb-3">
      <label for="selectFunction" class="form-label">Funci√≥n f(x)</label>
      <select class="form-select" id="selectFunction">
        <option value="custom">Escribir manualmente</option>
        <option value="x**3 - x - 2">x¬≥ - x - 2</option>
        <option value="x**2 - 4">x¬≤ - 4</option>
        <option value="cos(x) - x">cos(x) - x</option>
        <option value="exp(x) - 3*x">eÀ£ - 3x</option>
      </select>
      <input type="text" class="form-control mt-2" id="function" name="funcion" placeholder="Ej: x**3 - x - 2" required />
    </div>
    <div class="mb-3">
      <label for="x0" class="form-label">Valor inicial (x‚ÇÄ)</label>
      <input type="number" step="any" class="form-control" id="x0" name="x0" required />
    </div>
    <div class="mb-3">
      <label for="tolerancia" class="form-label">Tolerancia</label>
      <input type="number" step="any" class="form-control" id="tolerancia" name="tolerancia" value="0.0001" required />
    </div>
    <div class="mb-3">
      <label for="metodo" class="form-label">M√©todo</label>
      <select class="form-select" id="metodo" name="metodo">
        <option>Newton-Raphson</option>
        <option>Bisecci√≥n</option>
      </select>
    </div>
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="comparar" name="comparar" />
      <label class="form-check-label" for="comparar">Comparar con fzero()</label>
    </div>
    <div class="d-flex gap-2 flex-wrap mb-3">
      <button type="submit" class="btn btn-primary">Calcular</button>
      <button type="button" class="btn btn-outline-dark" onclick="abrirCalculadora()">üßÆ Calculadora</button>
      <a href="/historial" class="btn btn-outline-success">üìñ Ver Historial</a>
    </div>
  </form>

  <div id="result" class="mt-4"></div>
  <canvas id="errorChart" height="200" class="my-4"></canvas>
  <div class="table-responsive">
    <table class="table table-bordered" id="iterTable">
      <thead><tr><th>#</th><th>x</th><th>f(x)</th><th>Error</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
document.getElementById("selectFunction").addEventListener("change", () => {
  const sel = document.getElementById("selectFunction");
  const input = document.getElementById("function");
  input.value = sel.value === "custom" ? "" : sel.value;
});

let errorChart = null;

function abrirCalculadora() {
  const expr = prompt("üßÆ Ingresa una operaci√≥n matem√°tica:");
  if (expr) {
    try {
      const resultado = math.evaluate(expr);
      alert("Resultado: " + resultado);
    } catch (err) {
      alert("‚ö†Ô∏è Error en la operaci√≥n.");
    }
  }
}

document.getElementById("solveForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const data = {
    funcion: document.getElementById("function").value,
    x0: document.getElementById("x0").value,
    tolerancia: document.getElementById("tolerancia").value,
    metodo: document.getElementById("metodo").value,
    comparar: document.getElementById("comparar").checked
  };

  const res = await fetch("/solve", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const resultado = await res.json();
  if (resultado.error) {
    document.getElementById("result").innerHTML = `<div class="alert alert-danger">‚ùå ${resultado.error}</div>`;
    return;
  }

  document.getElementById("result").innerHTML = `
    <div class="alert alert-success">
      ‚úÖ Ra√≠z: ${resultado.raiz}<br>
      üîÅ Iteraciones: ${resultado.iteraciones}<br>
      üìå M√©todo: ${resultado.metodo}
      ${resultado.comparacion ? `<br>üîÑ fzero: ${resultado.comparacion.raiz}` : ""}
    </div>`;

  const tbody = document.querySelector("#iterTable tbody");
  tbody.innerHTML = "";
  resultado.pasos.forEach((p, i) => {
    tbody.innerHTML += `<tr><td>${i + 1}</td><td>${p.x}</td><td>${p.fx}</td><td>${p.error}</td></tr>`;
  });

  if (errorChart) errorChart.destroy();
  const ctx = document.getElementById("errorChart").getContext("2d");
  errorChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: resultado.pasos.map((_, i) => i + 1),
      datasets: [{
        label: "Error relativo",
        data: resultado.pasos.map(p => p.error),
        borderColor: "orange",
        tension: 0.2
      }]
    }
  });
});
</script>
</body>
</html>
